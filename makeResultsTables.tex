\Echapter{Creating Result Tables Automatically Using Make}{Maya Reiter}{mayar15@uw.edu}

Creating result tables illustrating the results of fMRI group analysis takes a LOT of time and effort, especially because FSL does not provide anatomical labels for each significant cluster. It is possible to identify anatomical regions of significant clusters using FSL \texttt{atlasquery} by hand, for each cluster, and copy paste these labels into a spreadsheet. This takes (or, I speculate that it takes --- as I decided that there must be a better way before even trying) hours on end! Moreover, if anything changes in your model, you will have to do this all over again! Rest assured, there is a better way.

In this example, I will introduce a program that I wrote (in \bashn{} and Python), that  creates result tables out of group analysis directories (truth be told, it also works on individual first level .feat directories). The product of this program is an almost-ready version of a table that you would publish in a journal article (Yay!). I have also found the result tables generated by this program a useful tool to display results as I am interpreting them. It's a nice way to "see it all at once".

This is also an example of how \maken{} can help you parallelize your favorite scripts, if you do not wish to re-write them in \maken{}. In this case, I had spent a full week creating this software using the \bashn{} and Python, and was pleased with the way it was working. Nevertheless, using \maken{}, I was able to parallelize this code using the \texttt{-j} flag. This allowed me to create result tables for different group analyses in parallel, and saved me a lot of computer time (my program takes a long time to run if there are many significant clusters). 

To run this example, you will need the example group analysis directory (\texttt{GROUP_2BACK.gfeat}), the Makefile, and all of the scripts in the \texttt{bin} directory. You will also need to have Python and FSL installed. Group Feat (\texttt{.gfeat}) directory names may \textbf{not} exceed 20 characters because spreadsheet tab names cannot exceed 20 characters. 

\paragraph{}The code for this example is in \texttt{\$MAKEPIPELINES/Gen_Result_Tables/Makefile}.

\section{Simple Result Tables}
\begin{lstlisting}
	SHELL=/bin/bash

	all: results1.txt results2.xlsx
  
	%*\lnote*results1.txt: GROUP_2BACK.gfeat
		bin/mScript_Get_feat_stats $< ;\
		mv GROUP_2BACK.gfeat_Feat_Results $@

	%*\lnote*results2.xlsx: results1.txt
		bin/mScript_make_result_tables -o $@ -f $(word 1,$^)

\end{lstlisting}

There are only two targets in this makefile: \texttt{results1.txt} and \texttt{results2}.
\lnum{1} \texttt{results1.txt} is a preliminary result table that has separate cells for the anatomical label as defined by each of the three atlases I chose to implement ("Harvard-Oxford Cortical Structural Atlas", "Harvard-Oxford Subcortical Structural Atlas", "Cerebellar Atlas in MNI152 space after normalization with FLIRT"). It also includes all atlas-defined regions encompassed by the clusters, no matter how low the probability that they belong to the region according to the atlas (0.07\% probability frontal pole gets included in this table). Indeed this table is useful for checking the probability that each cluster or peak of the cluster belongs to the anatomical region/structure defined by the atlas. 

Other than that, this table is a pain to look at. Each atlas is incomplete in terms of providing anatomical labels for the whole brain. Thus, looking up a cerebellum cluster in the Harvard-Oxford Subcortical Structural Atlas will leave you with a blank cell in this table. (As a side note, this program does not implement all atlases, and as such, does not provide specific anatomical labels for the brainstem or various nuclei, etc. This functionality can be added but I haven't done it yet).

\lnum{2}\texttt{results2.xlsx} is a far cleaner result table than \texttt{results1.txt}. The peak region is looked up in the three atlases, and the other regions that the cluster encompases are listed by order of probability (NOT peak/z-score). Only labels that have a probability of more than 5\% of belonging to that cluster are listed. Labels in this result table do not include white matter. Also, the program figures out which of the three atlases to use.

\section{Multiple Group Analyses} 

The other cool thing about the program \texttt{mScript_make_result_tables} is that it can assemble multiple group analyses (for each of which you would create a "results1-like" table first) in different worksheets within the spreadsheet. You can thus create one file (let's call it \texttt{ResultsForPaperX}) with multiple "tabs" or worksheets, one for each group analyses. For example, the first tab of this filecould be group differences and the second could be correlations with a behavioral measure. Here is an example of how you would make a Makefile to do that (this is not available in the examples directory). 

\begin{lstlisting}
	SHELL=/bin/bash
	export SHELL
	.PHONY: 
	all: GroupDifferences Correlations ResultsForPaperX
  
	GroupDifferences.txt: groupDifferencesAnalysis.gfeat
		bin/mScript_Get_feat_stats $< ;\
		mv groupDifferencesAnalysis.gfeat_Feat_Results $@
	
	Correlations.txt: correlationsAnalysis.gfeat
		bin/mScript_Get_feat_stats $< ;\
		mv correlationsAnalysis.gfeat_Feat_Results $@

	%*\lnote*ResultsForPaperX.xlsx: GroupDifferences.txt Correlations.txt
		bin/mScript_make_result_tables -o $@ -f $(word 1,$^),$(word 2,$^)

\end{lstlisting}

Here, we create tables from two group Feat directories (\texttt{groupDifferencesAnalysis.gfeat} and \texttt{correlationsAnalysis.gfeat}). Because these tables are independent of each other (they only depend on the gfeat directory), you can use the \texttt{-j } flag so that they are made in parallel (this is also the time consuming step!). \lnum{3} The file \texttt{ResultsForPaperX.xlsx} will be created from the tables \texttt{GroupDifferences.txt} and \texttt{Correlations.txt}. Because this target depends on \textbf{both} these tables, \maken{} will wait patiently until both are generated before it runs \texttt{mScript_make_result_tables}. Give it a try with your own group Feats!






