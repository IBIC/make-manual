\documentclass[oneside,11pt]{memoir}

% Fonts
\usepackage[T1]{fontenc}	% better output encoding
\usepackage{textcomp}		% For ASCII diacritics
\usepackage{lmodern}		% Latin Modern instad of CM
%\usepackage{inconsolata}	% better monospaced font
\usepackage[defaultsans]{droidsans} % straight quotes
\usepackage{microtype}		% fix the little things % comes after any fonts

% basics
\usepackage[textwidth=0.65\paperwidth]{geometry}	% Adjust margins
\usepackage{graphicx}	% now you can add pretty pictures
\usepackage{url} 		% makes urls look nicer
\usepackage[usenames,dvipsnames]{color} % adds colored text
\usepackage[font=footnotesize]{caption}	% more control over figure captions
\usepackage{xparse}		% nesting arguments wtihin environments
\usepackage{underscore}	% better text underscores
\usepackage{marginnote}	% better margin notes
\usepackage{tabularx}	% more flexible tables
\usepackage[table]{xcolor}	% alternating table colors
\usepackage{todonotes}	% backend organization. Also for some reason necessary for tikz
\usepackage[affil-sl]{authblk} % author block

% Complex packages
\usepackage{tikz}		% nice flowcharts and stuff
\usepackage{tcolorbox} 	% frames
\usepackage{listings} 	% nice code formatting
\usepackage{dirtree}	% pretty directory trees

% Lists
\usepackage[ampersand]{easylist}	% Nicer syntax for creating lists
\usepackage{paralist}	% Allows inline lists %
% For citations using Bibtex
\usepackage{natbib}

% Hyperref
\usepackage[colorlinks=true]{hyperref} 	% allows hyperlinking % NEEDS TO BE LOADED LAST
\hypersetup{citecolor=red}

% make underscore defaults to text mode over math mode
\catcode`_=12 

% Document information

\title{Using GNU \texttt{make} for Neuroimaging Workflow}


\author{Mary K. Askren} 		%(\url{askren@uw.edu})}
\author{Trevor K. McAllister-Day}	%(\url{tkmday@uw.edu})}
\author{Natalie Koh}					%(\url{natkoh@uw.edu})}
\author{Jennifer N. Dines} 	%(\url{jen.dines@gmail.com})}
\author{Benjamin A. Korman}	%(\url{bkorman@uw.edu})}
\author{Susan J. Melhorn}	%(\url{smelhorn@uw.edu})}
\author{Melissa A. Reilly}	 	%(\url{mreilly@uw.edu})}
\author{Karl A. Woelfer II} 	%(\url{kwoelfer@uw.edu})
\author{Tom J. Grabowski Jr.} 		%(\url{tgrabow@uw.edu})}
\author{Tara M. Madhyastha} 	%(\url{madhyt@uw.edu})}
\affil{University of Washington, Seattle}


% Set up the margins and the mymarginnote command
\setlrmargins{*}{*}{1}
\setmarginnotes{0.25in}{1in}{0.5in}
\checkandfixthelayout

\newcommand{\mymarginnote}[2]{\marginpar{{\small \sffamily \selectfont\fbox{\textbf{#1}} #2}}} % custom margin notes

% Code display commands
\newcommand\maken{\texttt{make}} % typeset 'make' always in monospace
\newcommand\bashn{\texttt{bash}} % same for 'bash'

\definecolor{textgray}{gray}{0.75} 
\makeatletter
\newcommand{\onelbox}[2]{%
	\setbox0=\hbox{#1}%
	\setlength{\@tempdima}{\dimexpr\wd0+13pt}%
	\begin{tcolorbox}[colback=#2,boxrule=0.5pt,arc=4pt,
		left=6pt,right=6pt,top=6pt,bottom=6pt,boxsep=0pt,width=\textwidth]
		#1
	\end{tcolorbox}
}
\makeatother

% ONE-LINE environments
% $ is automatically added to the bash prompt.
% % \hfill\, forces the minipage onto a new line. Don't ask.
\newcommand{\bashcmd}[1]{ \hfill\, \begin{minipage}[t]{\linewidth}  \hrule \vspace{0.5\baselineskip} \texttt{\small \$ #1} \vspace{0.5\baselineskip} \hrule \end{minipage} \vspace{0.5\baselineskip} }
\newcommand{\makecmd}[1]{ \vspace{0.5\baselineskip} \onelbox{\texttt{\small #1}}{white} \vspace{0.5\baselineskip} }
% Since these commands are embedded in floats, the nicest way to space them properly in the output
%% is to make sure that there is a newline between the command and the text you want to follow the figure.

% load languages for the listings class
\lstloadlanguages{bash, make}

%% DEFINE BASH MULTILINE ENVIRONMENT
\newenvironment{bash}[2] % 
{ \begin{samepage} \begin{figure}[h!] \def\captiontext{#1} \def\labelt{#2} \vspace{0.5\baselineskip} \hrule \vspace{0.5\baselineskip} \ttfamily } { \vspace{0.5\baselineskip} \hrule \vspace{0.5\baselineskip}  \caption{\captiontext} \label{\labelt} \end{figure} \end{samepage} } 

% DEFINE MAKE MULTILINE ENVIRONMENT
\newenvironment{make}[2] %
{ \begin{figure}[h!] \def\captiontext{#1} \def\labelt{#2} \begin{tcolorbox}[colback=white,boxrule=0.5pt,arc=4pt,left=6pt,right=6pt,boxsep=0pt,width=\textwidth] \raggedright \ttfamily } { \normalfont \end{tcolorbox} \caption{\captiontext} \label{\labelt} \end{figure} }
% You must terminate lines in the make environment
% To indent lines, use \tab

% use \maker to create recipes
\newcommand{\maker}[2]{\textcolor{blue}{#1}:\enspace#2}

% tab for indenting in make environment
\newcommand{\tab}{\hspace*{4em}}

% Specify command for "--"
% use this to specify bash long inputs (--) so they don't get swallowed up into hyphens.
% No space follows by default
\newcommand{\dd}{-{}-} 

% This is a better-looking #, I think
\newcommand{\mypound}{\protect\scalebox{0.8}{\protect\raisebox{0.4ex}{\#}}}

% % SOURCE CODE HIGHLIGHTING
\newcounter{codehighlight}
\newcommand*{\lnum}[1]{\tikz[baseline=(char.base)]{	\node[shape=rectangle,draw,inner sep=0.8pt, fill=black, text=white] (char) {\rmfamily\bfseries\scriptsize#1}; } }
\newcommand*{\lnote}{\stepcounter{codehighlight}\llap{{\lnum{\thecodehighlight}}\hskip 1em}} %6em original

% Change numbering
\setsecnumdepth{chapter}	% only number chapters
\maxtocdepth{subsection}	% put subsections in the table of contents
\makeatletter
\@addtoreset{chapter}{part}	% reset the chapter counter at each part
\makeatother

\pagestyle{ruled}	% Graphics command
\raggedbottom		% Allow more flexibility at the bottom of the page - helpful with lots of floats.

% Fix the spacing inbetween III and Examples
\cftsetindents{part}{0em}{2em}

% Use this command to include authors in the examples section.
\newcommand{\Echapter}[2]{\chapter[#1]{#1 \\ \normalfont \Large \textit{#2}}}

\begin{document}
	
	% Cover page
	
	\thispagestyle{empty}
	\begin{vplace}[0.7]
		\begin{center}
			\includegraphics[width=0.75\linewidth, natwidth=1890, natheight=761]{IBIClogo.png}				% IBIC logo
			\vspace{0.25in} \hrule \vspace{0.25in}															% vspace + hrule
			{ \fontsize{30pt}{36pt} \selectfont Using GNU \textsc{make} for Neuroimaging Workflow\par }		% Title
			\vspace{0.25in} \hrule \vspace{0.25in}															% vspace + hrule
			{\LARGE University of Washington} 																% University of Washington
		\end{center}	
	\end{vplace}
		
	
	\frontmatter	% Define the front matter section of the document
	
	\maketitle		% Title page
	
	\tableofcontents
	
	\listoffigures
	
	\mainmatter		% The actual content
	
	\part{Manual}
	
	\include{chapter1}	% Introduction to make
	
	\include{chapter2}	% Running make in context
	
	\include{chapter3}	% Running make in parallel
	
	\include{chapter4}  % Examples
	
	\part{Practicals}
	
	\begin{vplace}[0.7]
		
		\thispagestyle{empty}
		\large
		\noindent Part II will guide you through four \maken{} classes, using data available on the IBIC system and on NITRC. Each class is structured as a brief lecture followed by a practical designed to be completed as you read the chapter.
		
	\end{vplace}
	
	% change chapters to practicals
	\renewcommand{\chaptername}{Practical}
	\renewcommand{\chapterautorefname}{Practical}
	
	\include{practicum1}	% Overview of make
	
	\include{practicum2} 	% Make in context
	
	\include{practicum3} 	% Getting down and dirty
	
	\include{practicum4}	% Advanced topics & R markdown
	
	\part{Examples}
	% change practicals to examples
	\renewcommand{\chaptername}{Example}
	\renewcommand{\chapterautorefname}{Example}
	
	\include{makefile-examples} % How to execute FreeSurfer using make
	
%	\include{documentation} % How to document makefiles
	
	\appendix
	
%	\include{appendix}
	
	\bibliographystyle{apalike}
	\bibliography{references}
	
\end{document}
